<?xml version="1.0" encoding="UTF-8"?>
<objects xmlns="http://www.springframework.org/springpython/schema/objects/1.1"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/springpython/schema/objects/1.1
               http://springpython.webfactional.com/schema/context/spring-python-context-1.1.xsd">

    <object id="dp.dim.boe.modality" class="cubetl.olap.Dimension">
        <property name="name" value="modality" ></property>
        <property name="label" value="Modalidad" ></property>
        <property name="attributes">
            <list>
                <dict>
                    <entry><key><value>name</value></key><value>modality</value></entry>
                    <entry><key><value>type</value></key><value>String</value></entry>
                </dict>
            </list>
        </property>
    </object>

    <object id="dp.dim.boe.type" class="cubetl.olap.Dimension">
        <property name="name" value="type" ></property>
        <property name="label" value="Tipo" ></property>
        <property name="attributes">
            <list>
                <dict>
                    <entry><key><value>name</value></key><value>type</value></entry>
                    <entry><key><value>type</value></key><value>String</value></entry>
                </dict>
            </list>
        </property>
    </object>
    
    <object id="dp.dim.boe.tramitation" class="cubetl.olap.Dimension" >
        <property name="name" value="tramitation" ></property>
        <property name="label" value="Tramitación" ></property>
        <property name="attributes">
            <list>
                <dict>
                    <entry><key><value>name</value></key><value>tramitation</value></entry>
                    <entry><key><value>type</value></key><value>String</value></entry>
                </dict>
            </list>
        </property>
    </object>    

    <object id="dp.dim.boe.procedure" class="cubetl.olap.Dimension" >
        <property name="name" value="procedure" ></property>
        <property name="label" value="Procedimiento" ></property>
        <property name="attributes">
            <list>
                <dict>
                    <entry><key><value>name</value></key><value>procedure</value></entry>
                    <entry><key><value>label</value></key><value>Procedimiento</value></entry>
                    <entry><key><value>type</value></key><value>String</value></entry>
                </dict>
            </list>
        </property>
    </object>  
    
    <object id="dp.dim.boe.concept" class="cubetl.olap.Dimension" >
        <property name="name" value="boe_concept" ></property>
        <property name="label" value="Concepto" ></property>
        <property name="attributes">
            <list>
                <dict>
                    <entry><key><value>name</value></key><value>concept</value></entry>
                    <entry><key><value>type</value></key><value>String</value></entry>
                </dict>
            </list>
        </property>
    </object>    
    
    <object id="dp.dim.boe.geographic_scope" class="cubetl.olap.Dimension" >
        <property name="name" value="geographic_scope" ></property>
        <property name="label" value="Ámbito Geográfico" ></property>
        <property name="attributes">
            <list>
                <dict>
                    <entry><key><value>name</value></key><value>geographic_scope</value></entry>
                    <entry><key><value>type</value></key><value>String</value></entry>
                </dict>
            </list>
        </property>
    </object>

    
    <object id="dp.dim.boe.article" class="cubetl.olap.FactDimension" >
        <property name="name" value="boe_article" ></property>
        <property name="label" value="Artículo BOE" ></property>
        <property name="fact"><ref object="dp.fact.boe.article" /></property>
    </object>

    <object id="dp.fact.boe.analysis" class="cubetl.olap.Fact" >
        
        <property name="name" value="boe_analysis" />
        <property name="label" value="BOE / Análisis" />
        
        <property name="dimensions" >
            <list>
                <ref object="dp.dim.boe.article" />
                <ref object="dp.dim.boe.modality" />
                <ref object="dp.dim.boe.type" />
                <ref object="dp.dim.boe.tramitation" />
                <ref object="dp.dim.boe.procedure" />
                <ref object="dp.dim.boe.concept" />
                <ref object="dp.dim.boe.geographic_scope" />
            </list>
        </property>
        <property name="measures" >
            <list>
                <dict>
                    <entry><key><value>name</value></key><value>cost</value></entry>
                    <entry><key><value>type</value></key><value>Float</value></entry>
                </dict>
            </list>
        </property>
        <property name="attributes">
            <list>
                <dict> 
                    <entry><key><value>name</value></key><value>notes</value></entry>
                    <entry><key><value>type</value></key><value>String</value></entry>
                </dict>
            </list>
        </property>        
    </object>   

    <object id="dp.olapmapper.boe.analysis" class="cubetl.olap.OlapMapper" >
    
        <property name="include">
            <list>
                <ref object="dp.olapmapper.boe.article" />
            </list>
        </property>
    
        <property name="mappers">
            <list>
                <object class="cubetl.olap.sql.DimensionMapper" >
                    <property name="entity" ref="dp.dim.boe.modality" />
                    <property name="table" value="boe_modality" />
                    <property name="connection" ref="dp.sql.connection" />
                    <property name="mappings">
                        <list>
                            <dict>
                                <entry><key><value>name</value></key><value>id</value></entry>
                                <entry><key><value>value</value></key><value>${ m["modality_code"] }</value></entry>
                                <entry><key><value>pk</value></key><value>True</value></entry>
                                <entry><key><value>type</value></key><value>String</value></entry>
                            </dict>
                        </list>
                    </property>        
                </object>
                
                 <object class="cubetl.olap.sql.DimensionMapper" >
                    <property name="entity" ref="dp.dim.boe.type" />
                    <property name="table" value="boe_type" />
                    <property name="connection" ref="dp.sql.connection" />
                    <property name="mappings">
                        <list>
                            <dict>
                                <entry><key><value>name</value></key><value>id</value></entry>
                                <entry><key><value>value</value></key><value>${ m["type_code"] }</value></entry>
                                <entry><key><value>pk</value></key><value>True</value></entry>
                                <entry><key><value>type</value></key><value>Integer</value></entry>
                            </dict>
                        </list>
                    </property>        
                </object> 
                
                 <object class="cubetl.olap.sql.DimensionMapper" >
                    <property name="entity" ref="dp.dim.boe.tramitation" />
                    <property name="table" value="boe_tramitation" />
                    <property name="connection" ref="dp.sql.connection" />
                    <property name="mappings">
                        <list>
                            <dict>
                                <entry><key><value>name</value></key><value>id</value></entry>
                                <entry><key><value>value</value></key><value>${ m["tramitation_code"] }</value></entry>
                                <entry><key><value>pk</value></key><value>True</value></entry>
                                <entry><key><value>type</value></key><value>Integer</value></entry>
                            </dict>
                        </list>
                    </property>        
                </object>    
                
                <object class="cubetl.olap.sql.DimensionMapper" >
                    <property name="entity" ref="dp.dim.boe.procedure" />
                    <property name="table" value="boe_procedure" />
                    <property name="connection" ref="dp.sql.connection" />
                    <property name="mappings">
                        <list>
                            <dict>
                                <entry><key><value>name</value></key><value>id</value></entry>
                                <entry><key><value>value</value></key><value>${ m["procedure_code"] }</value></entry>
                                <entry><key><value>pk</value></key><value>True</value></entry>
                                <entry><key><value>type</value></key><value>Integer</value></entry>
                            </dict>
                        </list>
                    </property>        
                </object> 
                
                <object class="cubetl.olap.sql.DimensionMapper" >
                    <property name="entity" ref="dp.dim.boe.concept" />
                    <property name="table" value="boe_concept" />
                    <property name="connection" ref="dp.sql.connection" />
                    <property name="mappings">
                        <list>
                            <dict>
                                <entry><key><value>name</value></key><value>id</value></entry>
                                <entry><key><value>value</value></key><value>${ m["concept"].split(" ")[0] }</value></entry>
                                <entry><key><value>pk</value></key><value>True</value></entry>
                                <entry><key><value>type</value></key><value>String</value></entry>
                            </dict>
                        </list>
                    </property>        
                </object>                
                
                <object class="cubetl.olap.sql.DimensionMapper" >
                    <property name="entity" ref="dp.dim.boe.geographic_scope" />
                    <property name="table" value="boe_geographic_scope" />
                    <property name="connection" ref="dp.sql.connection" />
                    <property name="lookup_cols" value="geographic_scope" />
                    <property name="mappings">
                        <list>
                            <dict>
                                <entry><key><value>name</value></key><value>id</value></entry>
                                <entry><key><value>pk</value></key><value>True</value></entry>
                            </dict>
                        </list>
                    </property>        
                </object>
                
                <object class="cubetl.olap.sql.FactDimensionMapper" >
                    <property name="entity" ref="dp.dim.boe.article" />
                    <property name="mappings">
                        <list>
                            <dict>
                                <entry><key><value>name</value></key><value>boe_article</value></entry>
                                <entry><key><value>column</value></key><value>boe_article_id</value></entry>
                                <entry><key><value>value</value></key><value>${ text.slugu(m["id"]) }</value></entry>
                                <entry><key><value>pk</value></key><value>True</value></entry>
                            </dict>
                        </list>
                    </property>        
                </object>  
                
                <object class="cubetl.olap.sql.FactMapper" >
                    <property name="entity" ref="dp.fact.boe.analysis" />
                    <property name="table" value="boe_analysis" />
                    <property name="connection" ref="dp.sql.connection" />
                    <property name="mappings">
                        <list>
                            <dict>
                                <entry><key><value>name</value></key><value>id</value></entry>
                                <entry><key><value>value</value></key><value>${ text.slugu(m["id"]) }</value></entry>
                                <entry><key><value>pk</value></key><value>True</value></entry>
                            </dict>
                        </list>
                    </property>        
                </object>                
                
            </list>
        </property>
        
     </object>

    
    <object id="dp.process.boe.analysis" class="cubetl.flow.Chain" scope="singleton">
        <property name="fork" value="True" />
        <property name="steps">
            <list>
                
                <object class="cubetl.flow.Filter" >
			        <property name="condition"><value>${ m['xml'].xpath('string(//analisis/modalidad)').strip() != '' }</value></property>
			    </object>
    
                <object class="cubetl.xml.XPathExtract" >
			        <property name="eval">
			            <list>
			                <dict>
			                    <entry><key><value>name</value></key><value>modality</value></entry>
			                    <entry><key><value>xpath</value></key><value>string(//documento/analisis/modalidad)</value></entry>
			                    <entry><key><value>default</value></key><value>DESCONOCIDA</value></entry>
			                </dict>
			                <dict>
			                    <entry><key><value>name</value></key><value>modality_code</value></entry>
			                    <entry><key><value>xpath</value></key><value>string(//documento/analisis/modalidad/@codigo)</value></entry>
			                    <entry><key><value>default</value></key><value>0</value></entry>
			                </dict>
			                <dict>
			                    <entry><key><value>name</value></key><value>type</value></entry>
			                    <entry><key><value>xpath</value></key><value>string(//documento/analisis/tipo)</value></entry>
			                    <entry><key><value>default</value></key><value>DESCONOCIDO</value></entry>
			                </dict>
			                <dict>
			                    <entry><key><value>name</value></key><value>type_code</value></entry>
			                    <entry><key><value>xpath</value></key><value>string(//documento/analisis/tipo/@codigo)</value></entry>
			                    <entry><key><value>default</value></key><value>0</value></entry>
			                </dict>
			                <dict>
			                    <entry><key><value>name</value></key><value>tramitation</value></entry>
			                    <entry><key><value>xpath</value></key><value>string(//documento/analisis/tramitacion)</value></entry>
			                    <entry><key><value>default</value></key><value>DESCONOCIDO 0</value></entry>                    
			                </dict>
			                <dict>
			                    <entry><key><value>name</value></key><value>tramitation_code</value></entry>
			                    <entry><key><value>xpath</value></key><value>string(//documento/analisis/tramitacion/@codigo)</value></entry>
			                    <entry><key><value>default</value></key><value>0</value></entry>
			                </dict>
			                <dict>
			                    <entry><key><value>name</value></key><value>procedure</value></entry>
			                    <entry><key><value>xpath</value></key><value>string(//documento/analisis/procedimiento)</value></entry>
			                    <entry><key><value>default</value></key><value>DESCONOCIDO</value></entry>
			                </dict>
			                <dict>
			                    <entry><key><value>name</value></key><value>procedure_code</value></entry>
			                    <entry><key><value>xpath</value></key><value>string(//documento/analisis/procedimiento/@codigo)</value></entry>
			                    <entry><key><value>default</value></key><value>0</value></entry>
			                </dict>
			                
			                <dict>
			                    <entry><key><value>name</value></key><value>cost</value></entry>
			                    <entry><key><value>xpath</value></key><value>string(//documento/analisis/importe)</value></entry>
			                    <entry><key><value>value</value></key><value>${ text.extract_number(m["cost"]) }</value></entry>
			                </dict>
			                
			                <dict>
			                    <entry><key><value>name</value></key><value>geographic_scope</value></entry>
			                    <entry><key><value>xpath</value></key><value>string(//documento/analisis/ambito_geografico)</value></entry>
			                    <entry><key><value>default</value></key><value>Desconocido</value></entry>
			                </dict>
			                
			                <dict>
			                    <entry><key><value>name</value></key><value>geographic_scope</value></entry>
			                    <entry><key><value>value</value></key><value>${ (u"Varios (%d)" % (m["geographic_scope"].count("\n"))) if ("\n" in m["geographic_scope"]) else  m["geographic_scope"] }</value></entry>
			                </dict>
			                
			                <dict>
			                    <entry><key><value>name</value></key><value>concept</value></entry>
			                    <entry><key><value>xpath</value></key><value>string(//documento/analisis/materias_cpv)</value></entry>
			                    <entry><key><value>default</value></key><value>00000000 DESCONOCIDO</value></entry>
			                </dict>
			                
			                <dict>
			                    <entry><key><value>name</value></key><value>notes</value></entry>
			                    <entry><key><value>xpath</value></key><value>string(//documento/analisis/observaciones)</value></entry>
			                </dict>
			                
			            </list>
			        </property>  
			    </object>  
                
                <!-- 
                <object class="cubetl.util.log.Log" scope="singleton">
                     <property name="message" value="Geo: ${ m['geographic_scope'] }" />
                </object>
                 -->
                
                <object class="cubetl.olap.Store" >
			        <property name="entity" ref="dp.fact.boe.analysis" />
			        <property name="mapper" ref="dp.olapmapper.boe.analysis" />
			    </object> 

                <ref object="cubetl.util.print" />
                
            </list>
        </property>
                
    </object>    

</objects>
