<?xml version="1.0" encoding="UTF-8"?>
<objects xmlns="http://www.springframework.org/springpython/schema/objects/1.1"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/springpython/schema/objects/1.1
               http://springpython.webfactional.com/schema/context/spring-python-context-1.1.xsd">


    <object id="dp.dim.cg.date_provisional" class="cubetl.olap.AliasDimension" >
        <property name="name" value="date_provisional" />
        <property name="label" value="Fecha Provisional" />
        <property name="dimension" ref="cubetl.dim.datetime.date" />
    </object>
    
    <object id="dp.dim.cg.date_final" class="cubetl.olap.AliasDimension" >
        <property name="name" value="date_final" />
        <property name="label" value="Fecha Final" />
        <property name="dimension" ref="cubetl.dim.datetime.date" />
    </object>
     
    <object id="dp.dim.cg.company" class="cubetl.olap.Dimension" >
        <property name="name" value="company" ></property>
        <property name="label" value="Empresa" ></property>
        <property name="attributes">
            <list>
                <dict>
                    <entry><key><value>name</value></key><value>company</value></entry>
                    <entry><key><value>type</value></key><value>String</value></entry>
                </dict>
            </list>
        </property>
    </object>
    
    <object id="dp.dim.cg.type" class="cubetl.olap.Dimension" >
        <property name="name" value="type" ></property>
        <property name="label" value="Tipo" ></property>
        <property name="attributes">
            <list>
                <dict>
                    <entry><key><value>name</value></key><value>type</value></entry>
                    <entry><key><value>type</value></key><value>String</value></entry>
                </dict>
            </list>
        </property>
    </object>
    
    <object id="dp.dim.cg.contract" class="cubetl.olap.Dimension" >
        <property name="name" value="contract" ></property>
        <property name="label" value="Contrato" ></property>
        <property name="attributes">
            <list>
                <dict>
                    <entry><key><value>name</value></key><value>contract</value></entry>
                    <entry><key><value>type</value></key><value>String</value></entry>
                </dict>
            </list>
        </property>
    </object>           
    
    <object id="dp.dim.cg.state" class="cubetl.olap.Dimension" >
        <property name="name" value="state" ></property>
        <property name="label" value="Estado" ></property>
        <property name="attributes">
            <list>
                <dict>
                    <entry><key><value>name</value></key><value>state</value></entry>
                    <entry><key><value>type</value></key><value>String</value></entry>
                </dict>
            </list>
        </property>
    </object>       
    
    <object id="dp.fact.cg.process" class="cubetl.olap.Fact" >
    
        <property name="name" value="cg_process" />
        <property name="label" value="Contratos Galicia / Procedimientos" />
        
        <property name="dimensions" >
            <list>
                <ref object="dp.dim.cg.date_provisional" />
                <ref object="dp.dim.cg.date_final" />
                <ref object="dp.dim.cg.company" />
                <ref object="dp.dim.cg.type" />
                <ref object="dp.dim.cg.contract" />
                <ref object="dp.dim.cg.state" />
            </list>
        </property>
        <property name="measures" >
            <list>
                <dict>
                    <entry><key><value>name</value></key><value>procedure_cost</value></entry>
                    <entry><key><value>type</value></key><value>Float</value></entry>
                </dict>
                <dict>
                    <entry><key><value>name</value></key><value>contractor_cost</value></entry>
                    <entry><key><value>type</value></key><value>Float</value></entry>
                </dict>
            </list>
        </property>
        <property name="attributes">
            <list>
                <dict>
                    <entry><key><value>name</value></key><value>purpose</value></entry>
                    <entry><key><value>type</value></key><value>String</value></entry>
                </dict>
            </list>
        </property>        
    </object>    
    
    <object id="dp.olapmapper.cg.process" class="cubetl.olap.OlapMapper" scope="singleton">
    
        <property name="mappers">
            <list>
			    
			    <object class="cubetl.olap.sql.CompoundHierarchyDimensionMapper" >
                    <property name="entity" ref="dp.dim.cg.date_provisional" />
                    <property name="table" value="date" />
                    <property name="connection" ref="dp.sql.connection" />
                    <property name="eval">
                        <list>
                            <dict>
                                <entry><key><value>name</value></key><value>_cubetl_datetime_date</value></entry>
                                <entry><key><value>value</value></key><value>${ m['date_provisional'] }</value></entry>
                            </dict>
                        </list>                    
                    </property>
                    <property name="mappings">
                        <list>
                            <ref object="cubetl.mappings.datetime.date" />
                        </list>
                    </property>
			    </object>
			    
                <object class="cubetl.olap.sql.CompoundHierarchyDimensionMapper" >
                    <property name="entity" ref="dp.dim.cg.date_final" />
                    <property name="table" value="date" />
                    <property name="connection" ref="dp.sql.connection" />
                    <property name="eval">
                        <list>
                            <dict>
                                <entry><key><value>name</value></key><value>_cubetl_datetime_date</value></entry>
                                <entry><key><value>value</value></key><value>${ m['date_final'] }</value></entry>
                            </dict>
                        </list>                    
                    </property>
                    <property name="mappings">
                        <list>
                            <ref object="cubetl.mappings.datetime.date" />
                        </list>
                    </property>
                </object>			    
			    
			    <object class="cubetl.olap.sql.DimensionMapper" >
                    <property name="entity" ref="dp.dim.cg.company" />
                    <property name="table" value="cg_company" />
                    <property name="connection" ref="dp.sql.connection" />
                    <property name="lookup_cols" value="company" />
                    <property name="mappings">
                        <list>
                            <dict>
                                <entry><key><value>name</value></key><value>id</value></entry>
                                <entry><key><value>pk</value></key><value>True</value></entry>
                            </dict>
                        </list>
                    </property>        
                </object>
                
                <object class="cubetl.olap.sql.DimensionMapper" >
                    <property name="entity" ref="dp.dim.cg.type" />
                    <property name="table" value="cg_type" />
                    <property name="connection" ref="dp.sql.connection" />
                    <property name="lookup_cols" value="type" />
                    <property name="mappings">
                        <list>
                            <dict>
                                <entry><key><value>name</value></key><value>id</value></entry>
                                <entry><key><value>pk</value></key><value>True</value></entry>
                            </dict>
                        </list>
                    </property>        
                </object>
                
                <object class="cubetl.olap.sql.DimensionMapper" >
                    <property name="entity" ref="dp.dim.cg.contract" />
                    <property name="table" value="cg_contract" />
                    <property name="connection" ref="dp.sql.connection" />
                    <property name="lookup_cols" value="contract" />
                    <property name="mappings">
                        <list>
                            <dict>
                                <entry><key><value>name</value></key><value>id</value></entry>
                                <entry><key><value>pk</value></key><value>True</value></entry>
                            </dict>
                        </list>
                    </property>        
                </object>
			    
                <object class="cubetl.olap.sql.DimensionMapper" >
                    <property name="entity" ref="dp.dim.cg.state" />
                    <property name="table" value="cg_state" />
                    <property name="connection" ref="dp.sql.connection" />
                    <property name="lookup_cols" value="state" />
                    <property name="mappings">
                        <list>
                            <dict>
                                <entry><key><value>name</value></key><value>id</value></entry>
                                <entry><key><value>pk</value></key><value>True</value></entry>
                            </dict>
                        </list>
                    </property>        
                </object>
                
                
                <object class="cubetl.olap.sql.FactMapper" >
                    <property name="entity" ref="dp.fact.cg.process" />
                    <property name="table" value="cg_process" />
                    <property name="connection" ref="dp.sql.connection" />
                    <property name="store_mode" value="insert" />
                    <property name="mappings">
                        <list>
                            <dict>
                                <entry><key><value>name</value></key><value>id</value></entry>
                                <entry><key><value>value</value></key><value>${ int(m["id"]) }</value></entry>
                                <entry><key><value>pk</value></key><value>True</value></entry>
                                <entry><key><value>type</value></key><value>Integer</value></entry>
                            </dict>
                        </list>
                    </property>        
                </object>      
                
            </list>
        </property>
        
    </object>
    
    
    <object id="dp.process.cg.process" class="cubetl.flow.Chain" scope="singleton">
        <property name="steps">
            <list>

                <ref object="dp.sql.transaction" />
                
                <object class="cubetl.fs.DirectoryFileReader" >
			        <property name="path" value="${ ctx.props['path_data'] }/contratosdegalicia/data" />
			        <property name="filter_re" value=".*.html" />
			        <property name="encoding" value="latin-1" />
			    </object>
                
                <object class="cubetl.xml.TidyHtmlParser" >
                </object>

			    <object class="cubetl.flow.Filter" >
			        <property name="condition"><value>${| m['tidy'].find(".//{http://www.w3.org/1999/xhtml}div/{http://www.w3.org/1999/xhtml}h2[2]/{http://www.w3.org/1999/xhtml}span[2]") != None |}</value></property>
			        <!-- <property name="message"><value>Discarded ${ m["filename"] }</value></property>  -->
			    </object>

                <object class="cubetl.script.Eval" >
			        <property name="eval">
			            <list>
			                 <dict>
                                <entry><key><value>name</value></key><value>id</value></entry>
                                <entry><key><value>value</value></key><value>${ text.re_search("^.*licitacion-(\d+).html$", m["filename"], 1) }</value></entry>
                            </dict>
			                <dict>
			                    <entry><key><value>name</value></key><value>state</value></entry>
			                    <entry><key><value>value</value></key><value>${| m['tidy'].findtext(".//{http://www.w3.org/1999/xhtml}div/{http://www.w3.org/1999/xhtml}h2[2]/{http://www.w3.org/1999/xhtml}span[2]") |}</value></entry>
			                </dict>
			                <dict>
                                <entry><key><value>name</value></key><value>type</value></entry>
                                <entry><key><value>value</value></key><value>${| m['tidy'].findtext(".//{http://www.w3.org/1999/xhtml}table[1]/{http://www.w3.org/1999/xhtml}tr[2]/{http://www.w3.org/1999/xhtml}td") |}</value></entry>
                                <entry><key><value>value</value></key><value>${| m['tidy'].findtext(".//{http://www.w3.org/1999/xhtml}table[1]/{http://www.w3.org/1999/xhtml}tr[2]/{http://www.w3.org/1999/xhtml}td") |}</value></entry>
                            </dict>
                            <dict>
                                <entry><key><value>name</value></key><value>purpose</value></entry>
                                <entry><key><value>value</value></key><value>${| m['tidy'].findtext(".//{http://www.w3.org/1999/xhtml}table[1]/{http://www.w3.org/1999/xhtml}tr[2]/{http://www.w3.org/1999/xhtml}td[3]") |}</value></entry>
                            </dict>
                            <dict>
                                <entry><key><value>name</value></key><value>contract</value></entry>
                                <entry><key><value>value</value></key><value>${| m['tidy'].findtext(".//{http://www.w3.org/1999/xhtml}table[2]/{http://www.w3.org/1999/xhtml}tr[2]/{http://www.w3.org/1999/xhtml}td") |}</value></entry>
                            </dict>
                            <dict>
                                <entry><key><value>name</value></key><value>procedure_cost</value></entry>
                                <entry><key><value>value</value></key><value>${| text.extract_number(m['tidy'].findtext(".//{http://www.w3.org/1999/xhtml}table[1]/{http://www.w3.org/1999/xhtml}tr[2]/{http://www.w3.org/1999/xhtml}td[4]")) |}</value></entry>
                            </dict>
                            <dict>
                                <entry><key><value>name</value></key><value>company</value></entry>
                                <entry><key><value>value</value></key><value>${| m['tidy'].findtext("{http://www.w3.org/1999/xhtml}td[3]") |}</value></entry>
                                <entry><key><value>default</value></key><value>N/A</value></entry>
                            </dict>
                            
                            <!-- 
                            <dict>
                                <entry><key><value>name</value></key><value>resolution</value></entry>
                                <entry><key><value>value</value></key><value>${| m['tidy'].findtext('.//{http://www.w3.org/1999/xhtml}div[@id="tabs-3"]//{http://www.w3.org/1999/xhtml}table') |}</value></entry>
                            </dict>
                             -->
                            
			            </list>
			        </property>  
			    </object>   

                <object class="cubetl.script.Script">
                    <property name="code"><value><![CDATA[

import datetime
from cubetl.functions import text

resolution = m['tidy'].find('.//{http://www.w3.org/1999/xhtml}div[@id="tabs-3"]//{http://www.w3.org/1999/xhtml}table')

if (resolution != None):
	for tr in resolution.findall('{http://www.w3.org/1999/xhtml}tr'):
	    
	    #if (tr.findtext("{http://www.w3.org/1999/xhtml}td[1]") == "Provisional"):
	    date = tr.findtext("{http://www.w3.org/1999/xhtml}td[5]")
	    if (date):
	       date = date.split("-")
	       if (len(date) != 3): continue
	       m["date_provisional"] = datetime.date(int(date[2]), int(date[1]), int(date[0]))
	    
	    if (tr.findtext("{http://www.w3.org/1999/xhtml}td[4]") != ""):
	        m["contractor_cost"] = text.extract_number(tr.findtext("{http://www.w3.org/1999/xhtml}td[4]"))
	        date = tr.findtext("{http://www.w3.org/1999/xhtml}td[5]")
	        if (date):
	           date = date.split("-")
	           m["date_final"] = datetime.date(int(date[2]), int(date[1]), int(date[0]))
	    else:
	        logger.debug("Missing final amount in %s" % m["filename"])
	        m["date_final"] = datetime.date(1979, 1, 1)
	        m["contractor_cost"] = 0

if (not "date_provisional" in m): m["date_provisional"] = datetime.date(1979, 1, 1)
if (not "date_final" in m): m["date_final"] = datetime.date(1979, 1, 1)
if (not "contractor_cost" in m): m["contractor_cost"] = 0
    
                    ]]></value></property>
                </object> 

                
<!-- 
			    <object class="cubetl.script.Script">
			        <property name="code"><value><![CDATA[
del(m["tidy"])
del(m["data"])
m["test_script"] = True
			        ]]></value></property>
			    </object>  
 -->

                <object class="cubetl.olap.Store" >
			        <property name="entity" ref="dp.fact.cg.process" />
			        <property name="mapper" ref="dp.olapmapper.cg.process" />
			    </object> 

                <ref object="cubetl.util.print" />

                <!-- <ref object="node-storerow" />  -->
                
                <ref object="dp.node.logperformance" />
                
            </list>
        </property>  
    </object>

</objects>
