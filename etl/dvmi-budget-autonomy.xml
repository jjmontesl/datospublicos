<?xml version="1.0" encoding="UTF-8"?>
<objects xmlns="http://www.springframework.org/springpython/schema/objects/1.1"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/springpython/schema/objects/1.1
               http://springpython.webfactional.com/schema/context/spring-python-context-1.1.xsd">

    <object id="dp.dim.budget.function" class="cubetl.olap.Dimension" scope="singleton">
    
        <property name="name" value="function" ></property>
        <property name="label" value="Función" ></property>
        <property name="attributes">
            <list>
                <dict>
                    <entry><key><value>name</value></key><value>function</value></entry>
                    <entry><key><value>type</value></key><value>String</value></entry>
                </dict>
            </list>
        </property>
    </object>

    <object id="dp.fact.budget.autonomy" class="cubetl.olap.Fact" scope="singleton">
        
        <property name="name" value="dvmi_budget_autonomy" />
        <property name="label" value="DVMI / Presupuestos Autonómicos" />
        
        <property name="dimensions" >
            <list>
                <ref object="cubetl.dim.datetime.year" />
                <ref object="dp.dim.ine.autonomy" />
                <ref object="dp.dim.budget.function" />
            </list>
        </property>
        <property name="measures" >
            <list>
                <dict>
                    <entry><key><value>name</value></key><value>expense_total</value></entry>
                    <entry><key><value>type</value></key><value>Integer</value></entry>
                </dict>
                <dict>
                    <entry><key><value>name</value></key><value>expense_per_person</value></entry>
                    <entry><key><value>type</value></key><value>Integer</value></entry>
                    <entry><key><value>aggregations</value></key><value>sum</value></entry>
                </dict>
                <dict>
                    <entry><key><value>name</value></key><value>expense_per_autonomy_person</value></entry>
                    <entry><key><value>type</value></key><value>Integer</value></entry>
                    <entry><key><value>aggregations</value></key><value>sum</value></entry>
                </dict>
            </list>
        </property>
    </object> 

    <object id="dp.olapmapper.budget.autonomy" class="cubetl.olap.OlapMapper" scope="singleton">
    
        <property name="include">
            <list>
                <ref object="dp.olapmapper.ine.census" />
            </list>
        </property>
    
        <property name="mappers">
            <list>

                <object class="cubetl.olap.sql.DimensionMapper" >
                    
                    <property name="entity" ref="dp.dim.budget.function" />
                    <property name="table" value="dvmi_function" />
                    <property name="connection" ref="dp.sql.connection" />
                    
                    <property name="mappings">
                        <list>
                            <dict>
                                <entry><key><value>name</value></key><value>id</value></entry>
                                <entry><key><value>value</value></key><value>${ m["function_id"] }</value></entry>
                                <entry><key><value>pk</value></key><value>True</value></entry>
                                <entry><key><value>type</value></key><value>Integer</value></entry>
                            </dict>
                            <dict>
                                <entry><key><value>name</value></key><value>function</value></entry>
                                <entry><key><value>value</value></key><value>${ m["function_function"] }</value></entry>
                            </dict>                            
                        </list>
                    </property>        
                </object>
                
                <object class="cubetl.olap.sql.FactMapper" >
                    
                    <property name="entity" ref="dp.fact.budget.autonomy" />
                    <property name="table" value="dvmi_budget_autonomy" />
                    <property name="connection" ref="dp.sql.connection" />
                    
                    <property name="lookup_cols" value="year, autonomy_id, function_id" />
                    
                    <property name="auto_store">
                        <list>
			                <!-- <ref object="cubetl.dim.datetime.year" />  -->
			                <ref object="dp.dim.budget.function" />
                        </list>
                    </property>
                    <property name="mappings">
                        <list>
                            <dict>
                                <entry><key><value>name</value></key><value>id</value></entry>
                                <entry><key><value>pk</value></key><value>True</value></entry>
                                <entry><key><value>type</value></key><value>AutoIncrement</value></entry>
                            </dict>
                        </list>
                    </property>        
                </object>                
                
            </list>
        </property>
        
    </object>

	<object id="dp.process.budget.autonomy" class="cubetl.flow.Chain" scope="singleton">
	
		<property name="fork" value="True" />
		<property name="steps">
			<list>

				<ref object="dp.sql.transaction" />

				<object class="cubetl.csv.CsvFileReader">
					<property name="filename" value="${ ctx.props['path_data'] }/dvmi/data/censo/BudgetData.csv" />
					<property name="header" value="True" />
					<!-- <property name="encoding" value="utf-8" />  -->
				</object>

				<object class="cubetl.script.Eval">
					<property name="eval">
						<list>
							<dict>
								<entry><key><value>name</value></key><value>autonomy_id</value></entry>
								<entry><key><value>value</value></key><value>${ m['Idcomu'] }</value></entry>
							</dict>
                            <dict>
                                <entry><key><value>name</value></key><value>autonomy_name</value></entry>
                                <entry><key><value>value</value></key><value>${ None }</value></entry>
                            </dict>                            
							<dict>
								<entry><key><value>name</value></key><value>function_id</value></entry>
								<entry><key><value>value</value></key><value>${ m['Codigo'] }</value></entry>
							</dict>
							<dict>
                                <entry><key><value>name</value></key><value>function_function</value></entry>
                                <entry><key><value>value</value></key><value>${ m['Funcion'] }</value></entry>
                            </dict>
                            <dict>
                                <entry><key><value>name</value></key><value>expense_total</value></entry>
                                <entry><key><value>value</value></key><value>${ text.extract_number(m['Total']) }</value></entry>
                            </dict>
                            <dict>
                                <entry><key><value>name</value></key><value>year</value></entry>
                                <entry><key><value>value</value></key><value>${ m['Ano'] }</value></entry>
                            </dict>
                        </list>
                    </property>
                </object>

                <object class="cubetl.sql.cache.CachedQueryLookup">
                    <property name="connection" ref="dp.sql.connection" />
                    <property name="query"><value>
                        select sum(census) as census_autonomy from ine_census where autonomy_id = '${ m["autonomy_id"] }' and year = '${ m["year" ] }'
                    </value></property>
                </object>
                <object class="cubetl.sql.cache.CachedQueryLookup">
                    <property name="connection" ref="dp.sql.connection" />
                    <property name="query"><value> 
                        select sum(census) as census_total from ine_census where year = '${ m["year" ]}'
                    </value></property>
                </object>                
                            
                <object class="cubetl.script.Eval">
                    <property name="eval">
                        <list>                            
                            <dict>
                                <entry><key><value>name</value></key><value>expense_per_person</value></entry>
                                <entry><key><value>value</value></key><value>${ m["expense_total"] / m["census_total"] }</value></entry>
                            </dict>
                            <dict>
                                <entry><key><value>name</value></key><value>expense_per_autonomy_person</value></entry>
                                <entry><key><value>value</value></key><value>${ m["expense_total"] / m["census_autonomy"] }</value></entry>
                            </dict>
						</list>
					</property>
				</object>
                
                <ref object="cubetl.util.print" />  

			    <object class="cubetl.olap.Store" >
			        <property name="entity" ref="dp.fact.budget.autonomy" />
			        <property name="mapper" ref="dp.olapmapper.budget.autonomy" />
			    </object>

				<ref object="dp.node.logperformance" />

			</list>
		</property>
	</object>

</objects>
