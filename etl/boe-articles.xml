<?xml version="1.0" encoding="UTF-8"?>
<objects xmlns="http://www.springframework.org/springpython/schema/objects/1.1"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/springpython/schema/objects/1.1
               http://springpython.webfactional.com/schema/context/spring-python-context-1.1.xsd">


    <object id="dp.dim.boe.datepublished" class="cubetl.olap.AliasDimension" >
        <property name="name" value="date_published" />
        <property name="label" value="Fecha Publicación" />
        <property name="dimension" ref="cubetl.dim.datetime.date" />
    </object>
     
    <object id="dp.dim.boe.department" class="cubetl.olap.Dimension" >
        <property name="name" value="department" ></property>
        <property name="label" value="Departamento" ></property>
        <property name="attributes">
            <list>
                <dict>
                    <entry><key><value>name</value></key><value>department</value></entry>
                    <entry><key><value>type</value></key><value>String</value></entry>
                </dict>
            </list>
        </property>
    </object>
    
    <object id="dp.dim.boe.imageletter" class="cubetl.olap.Dimension" >
        <property name="name" value="imageletter" ></property>
        <property name="label" value="Letra Imagen" ></property>
        <property name="attributes">
            <list>
                <dict>
                    <entry><key><value>name</value></key><value>image_letter</value></entry>
                    <entry><key><value>type</value></key><value>String</value></entry>
                </dict>
            </list>
        </property>
    </object>
    
    <object id="dp.dim.boe.section" class="cubetl.olap.Dimension">
        <property name="name" value="section" ></property>
        <property name="label" value="Seccion" ></property>
        <property name="attributes">
            <list>
                <dict>
                    <entry><key><value>name</value></key><value>section</value></entry>
                    <entry><key><value>type</value></key><value>String</value></entry>
                </dict>
            </list>
        </property>
    </object>        

    <object id="dp.dim.boe.journal_num" class="cubetl.olap.Dimension">
        <property name="name" value="journal_num" ></property>
        <property name="label" value="Diario" ></property>
        <property name="attributes">
            <list>
                <dict>
                    <entry><key><value>name</value></key><value>journal_num</value></entry>
                    <entry><key><value>type</value></key><value>Integer</value></entry>
                </dict>
            </list>
        </property>
    </object>

    <object id="dp.dim.boe.hasanalysis" class="cubetl.olap.Dimension">
        <property name="name" value="hasanalysis" ></property>
        <property name="label" value="Análisis" ></property>
        <property name="attributes">
            <list>
                <dict>
                    <entry><key><value>name</value></key><value>hasanalysis</value></entry>
                    <entry><key><value>type</value></key><value>Boolean</value></entry>
                </dict>
            </list>
        </property>
    </object>
    
    <object id="dp.fact.boe.article" class="cubetl.olap.Fact" >
    
        <property name="name" value="boe_article" />
        <property name="label" value="BOE / Artículos" />
        
        <property name="dimensions" >
            <list>
                <ref object="dp.dim.boe.datepublished" />
                <ref object="dp.dim.boe.department" />
                <ref object="dp.dim.boe.imageletter" />
                <ref object="dp.dim.boe.section" />
                <ref object="dp.dim.boe.journal_num" />
                <ref object="dp.dim.boe.hasanalysis" />
            </list>
        </property>
        <property name="measures" >
            <list>
                <dict>
                    <entry><key><value>name</value></key><value>page_count</value></entry>
                    <entry><key><value>type</value></key><value>Integer</value></entry>
                </dict>
            </list>
        </property>
        <property name="attributes">
            <list>
                <dict>
                    <entry><key><value>name</value></key><value>url_pdf</value></entry>
                    <entry><key><value>type</value></key><value>String</value></entry>
                </dict>
                <dict>
                    <entry><key><value>name</value></key><value>page_start</value></entry>
                    <entry><key><value>type</value></key><value>Integer</value></entry>
                </dict>                
                <dict>
                    <entry><key><value>name</value></key><value>page_end</value></entry>
                    <entry><key><value>type</value></key><value>Integer</value></entry>
                </dict>
            </list>
        </property>        
    </object>    
    
    <object id="dp.olapmapper.boe.article" class="cubetl.olap.OlapMapper" scope="singleton">
    
        <property name="mappers">
            <list>
            
                <object class="cubetl.olap.sql.CompoundHierarchyDimensionMapper" >
                    <property name="entity" ref="dp.dim.boe.datepublished" />
                    <property name="table" value="date" />
                    <property name="connection" ref="dp.sql.connection" />
                    <property name="eval">
                        <list>
                            <dict>
                                <entry><key><value>name</value></key><value>_cubetl_datetime_date</value></entry>
                                <entry><key><value>value</value></key><value>${ m['date_published'] }</value></entry>
                            </dict>
                        </list>                    
                    </property>
                    <property name="mappings">
                        <list>
                            <ref object="cubetl.mappings.datetime.date" />
                        </list>
                    </property>
                </object>
            
                <object class="cubetl.olap.sql.DimensionMapper" >
                    <property name="entity" ref="dp.dim.boe.department" />
                    <property name="table" value="boe_department" />
                    <property name="connection" ref="dp.sql.connection" />
                    <property name="mappings">
                        <list>id
                            <dict>
                                <entry><key><value>name</value></key><value>id</value></entry>
                                <entry><key><value>value</value></key><value>${ text.slugu( m["department"] ) }</value></entry>
                                <entry><key><value>pk</value></key><value>True</value></entry>
                                <entry><key><value>type</value></key><value>String</value></entry>
                            </dict>
                            <dict>
                                <entry><key><value>name</value></key><value>department</value></entry>
                            </dict>
                        </list>
                    </property>        
                </object>	
                
                <object class="cubetl.olap.sql.DimensionMapper" >
                    <property name="entity" ref="dp.dim.boe.imageletter" />
                    <property name="table" value="boe_imageletter" />
                    <property name="connection" ref="dp.sql.connection" />
                    <property name="mappings">
                        <list>
                            <dict>
                                <entry><key><value>name</value></key><value>id</value></entry>
                                <entry><key><value>value</value></key><value>${ m["image_letter"] }</value></entry>
                                <entry><key><value>pk</value></key><value>True</value></entry>
                                <entry><key><value>type</value></key><value>String</value></entry>
                            </dict>
                        </list>
                    </property>        
                </object>    
                
                <object class="cubetl.olap.sql.EmbeddedDimensionMapper" >
                    <property name="entity" ref="dp.dim.boe.section" />
                </object> 
                
                <object class="cubetl.olap.sql.EmbeddedDimensionMapper" >
                    <property name="entity" ref="dp.dim.boe.journal_num" />
                    <property name="mappings">
                        <list>
                            <dict>
                                <entry><key><value>name</value></key><value>journal_num</value></entry>
                            </dict>
                        </list>
                    </property>        
                </object>                 
                
                <object class="cubetl.olap.sql.EmbeddedDimensionMapper" >
                    <property name="entity" ref="dp.dim.boe.hasanalysis" />
                    <property name="mappings">
                        <list>
                            <dict>
                                <entry><key><value>name</value></key><value>hasanalysis</value></entry>
                            </dict>
                        </list>
                    </property>        
                </object>                 
                
                <object class="cubetl.olap.sql.FactMapper" >
                    <property name="entity" ref="dp.fact.boe.article" />
                    <property name="table" value="boe_article" />
                    <property name="connection" ref="dp.sql.connection" />
                    <property name="store_mode" value="lookup" />
                    <property name="mappings">
                        <list>
                            <dict>
                                <entry><key><value>name</value></key><value>id</value></entry>
                                <entry><key><value>value</value></key><value>${ text.slugu(m["id"]) }</value></entry>
                                <entry><key><value>pk</value></key><value>True</value></entry>
                            </dict>
                        </list>
                    </property>        
                </object>      
                
            </list>
        </property>
        
    </object>
    
    
    <object id="dp.process.boe.articles" class="cubetl.flow.Chain" scope="singleton">
        <property name="steps">
            <list>

                <ref object="dp.sql.transaction" />
                
                <object class="cubetl.fs.DirectoryFileReader" >
			        <property name="path" value="${ ctx.props['path_data'] }/boe/data/${ ctx.props['boe_year'] }" />
			        <property name="filter_re" value=".*.xml" />
			        <property name="encoding" value="latin-1" />
			    </object>
                
                <object class="cubetl.flow.Filter" scope="singleton">
                    <property name="condition"><value>${ m['data'].strip() != "" }</value></property>
                    <property name="message"><value>Filtering empty article: ${ m["filename"] }</value></property>
                </object>
                
                
                <object class="cubetl.xml.XmlParser" >
                </object>

                <object class="cubetl.xml.XPathExtract" >
			        <property name="eval">
			            <list>
			                <dict>
			                    <entry><key><value>name</value></key><value>id</value></entry>
			                    <entry><key><value>xpath</value></key><value>string(//documento/metadatos/identificador)</value></entry>
			                </dict>
			                <dict>
			                    <entry><key><value>name</value></key><value>department</value></entry>
			                    <entry><key><value>xpath</value></key><value>string(//documento/metadatos/departamento)</value></entry>
			                </dict>
			                <dict>
			                    <entry><key><value>name</value></key><value>page_start</value></entry>
			                    <entry><key><value>xpath</value></key><value>string(//documento/metadatos/pagina_inicial)</value></entry>
			                </dict>
			                <dict>
			                    <entry><key><value>name</value></key><value>page_end</value></entry>
			                    <entry><key><value>xpath</value></key><value>string(//documento/metadatos/pagina_final)</value></entry>
			                </dict>
			                <dict>
			                    <entry><key><value>name</value></key><value>page_count</value></entry>
			                    <entry><key><value>value</value></key><value>${ int(m["page_end"]) - int(m["page_start"]) + 1 if (m["page_end"] != "" and m["page_start"] != "") else 0 }</value></entry>
			                </dict>
			                <dict>
			                    <entry><key><value>name</value></key><value>journal_num</value></entry>
			                    <entry><key><value>xpath</value></key><value>string(//documento/metadatos/diario_numero)</value></entry>
			                </dict>                
			                <dict>
			                    <entry><key><value>name</value></key><value>section</value></entry>
			                    <entry><key><value>xpath</value></key><value>string(//documento/metadatos/seccion)</value></entry>
			                </dict>
			                <dict>
			                    <entry><key><value>name</value></key><value>image_letter</value></entry>
			                    <entry><key><value>xpath</value></key><value>string(//documento/metadatos/letra_imagen)</value></entry>
			                </dict>
			                <dict>
			                    <entry><key><value>name</value></key><value>url_pdf</value></entry>
			                    <entry><key><value>xpath</value></key><value>string(//documento/metadatos/url_pdf)</value></entry>
			                </dict>
			                <dict>
			                    <entry><key><value>name</value></key><value>date_published</value></entry>
			                    <entry><key><value>xpath</value></key><value>string(//documento/metadatos/fecha_publicacion)</value></entry>
			                    <entry><key><value>value</value></key><value>${ text.extract_date(m["date_published"]) }</value></entry>
			                </dict>
			                <!-- <dict>
			                    <entry><key><value>name</value></key><value>date_update</value></entry>
			                    <entry><key><value>xpath</value></key><value>string(//documento/@fecha_actualizacion)</value></entry>
			                </dict>  -->
			                <dict>
			                    <entry><key><value>name</value></key><value>hasanalysis</value></entry>
			                    <entry><key><value>value</value></key><value>${ m['xml'].xpath('string(//analisis/modalidad)').strip() != '' }</value></entry>
			                </dict>
			            </list>
			        </property>  
			    </object>   
                

                <object class="cubetl.olap.Store" >
			        <property name="entity" ref="dp.fact.boe.article" />
			        <property name="mapper" ref="dp.olapmapper.boe.article" />
			    </object> 

                <ref object="dp.process.boe.analysis" />  

			    <object class="cubetl.script.Script">
			        <property name="code"><value><![CDATA[
del(m["xml"])
del(m["data"])
m["test_script"] = True
			        ]]></value></property>
			    </object>  

                <ref object="cubetl.util.print" />
                
                <!-- <ref object="node-storerow" />  -->
                
                <ref object="dp.node.logperformance" />
                
            </list>
        </property>  
    </object>

</objects>
